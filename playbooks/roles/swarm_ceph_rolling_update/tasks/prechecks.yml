---
- name: Check Ceph health
  ansible.builtin.command: ceph health
  register: ceph_health
  changed_when: false
  failed_when: ceph_health.rc != 0
  when: require_ceph_healthy

- name: Fail if Ceph is not healthy
  ansible.builtin.fail:
    msg: "Ceph not healthy on {{ inventory_hostname }}: {{ ceph_health.stdout | default('no output') }}"
  when:
    - require_ceph_healthy
    - ceph_health.stdout is not search(ceph_health_ok_regex)

- name: Check if this host is in a Docker Swarm
  ansible.builtin.command: docker info -f '{{ "{{" }} .Swarm.LocalNodeState {{ "}}" }}'
  register: swarm_state
  changed_when: false
  failed_when: false

- name: "Set fact: in_swarm"
  ansible.builtin.set_fact:
    in_swarm: "{{ (swarm_state.stdout | default('')) == 'active' }}"